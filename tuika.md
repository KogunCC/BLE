# Bluetoothデバイス位置情報追跡機能 - 要件定義

## 概要

本機能は、ユーザーがBluetoothデバイスの置き忘れや紛失を防ぐことを目的とし、デバイスの接続状態と連動して位置情報を記録・表示するものです。

## 機能要件

### 1. 接続中デバイスの現在位置表示

- **目的:** ユーザーが現在接続中のデバイスがどこにあるかを即座に確認できるようにする。
- **詳細:**
    - `connect_page` (接続中デバイスの詳細画面) に「現在位置を表示」ボタンを配置する。
    - ボタン押下時、**スマートフォンの現在位置情報**を取得し、外部の地図アプリケーション（例: Googleマップ, Appleマップ）を起動してその位置を表示する。
    - **重要:** Bluetoothデバイス自体にGPS機能はないため、表示されるのは**デバイスと接続中のスマートフォンの位置**である。

### 2. デバイス切断時の位置情報記録

- **目的:** デバイスが接続を失った際の最終位置を記録し、後から追跡できるようにする。
- **詳細:**
    - Bluetoothデバイスが切断された際、その瞬間の**スマートフォンの位置情報**を自動的に取得する。
    - 取得した位置情報を、切断された各デバイスに紐付けて永続的に保存する。
    - **補足:** 複数の切断履歴を保持するか、最新の切断位置のみを保持するかは、実装時に検討する。

### 3. 切断デバイスの最終位置表示

- **目的:** ユーザーが切断されたデバイスの最終確認位置を地図上で確認できるようにする。
- **詳細:**
    - メイン画面の「切断されたデバイス」リストにおいて、各デバイスの最終記録位置を表示するための操作（例: ボタン、タップアクション）を提供する。
    - 当該操作が実行された際、保存されているそのデバイスの最終位置情報を取得し、外部の地図アプリケーションを起動してその位置を表示する。

### 4. デバイス削除時の位置情報削除

- **目的:** デバイスがアプリから削除された際に、関連するすべての位置情報もクリーンアップする。
- **詳細:**
    - アプリ内でデバイスが削除（ペアリング解除）された際、そのデバイスに紐づく記憶された位置情報も同時に永続ストレージから削除する。

## 前提条件

- アプリケーションがスマートフォンの位置情報サービスへのアクセス許可（パーミッション）をユーザーから取得できること。
- 外部の地図アプリケーションがスマートフォンにインストールされており、URLスキーム等で連携可能であること。

## 技術的考慮事項 (LLM向け)

- **位置情報取得:** `geolocator` などのFlutterパッケージを利用。
- **地図アプリ連携:** `url_launcher` などのFlutterパッケージを利用。
- **バックグラウンド処理:** デバイス切断時の位置情報記録のため、プラットフォーム固有のバックグラウンド処理（Android Service, iOS Background Modes）の検討が必要となる場合がある。
- **データ永続化:** `shared_preferences` またはより堅牢なローカルデータベース（例: `sqflite`, `hive`）を利用して位置情報を保存する。
- **UI/UX:** 位置情報ボタンの配置、地図表示への遷移、ユーザーへのフィードバック（例: 位置情報取得中メッセージ）を考慮する。
