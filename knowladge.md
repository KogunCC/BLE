# プロジェクト知見サマリー

このドキュメントは、`bleapp` プロジェクトに関する技術的な知見や構造をまとめたものです。

## 1. プロジェクト概要

- **名称**: `bleapp`
- **目的**: Bluetooth Low Energy (BLE) デバイスのスキャン、接続、管理を行うためのFlutterアプリケーション。
- **プラットフォーム**: Flutterフレームワークを利用したクロスプラットフォーム（iOS, Android, Web, Desktopなど）。

## 2. 技術スタック

- **フレームワーク**: Flutter
- **言語**: Dart
- **主要なライブラリ**:
    - `flutter_blue_plus`: BLE通信のコア機能を提供。デバイスのスキャン、接続、切断、キャラクタリスティックの読み書きなどを担当。
    - `shared_preferences`: ペアリング済みのデバイス情報など、少量のデータをデバイスのローカルストレージに永続化するために使用。
    - `permission_handler`: Bluetoothや位置情報など、OSレベルでのパーミッション要求を管理。
    - `geolocator`: スマートフォンの位置情報を高精度に取得するために使用。
    - `url_launcher`: 外部の地図アプリケーション（Googleマップ、Appleマップなど）を起動するために使用。
    - **データ永続化**: 位置情報履歴の保存には、`shared_preferences`の他、より堅牢な`sqflite`や`hive`などのローカルデータベースの利用も検討。

## 3. プロジェクト構造

### `lib/` ディレクトリ
アプリケーションの主要なDartソースコードが格納されています。

- `main.dart`:
    - アプリケーションのエントリーポイント。
    - 接続済み・未接続デバイスのリストを表示するメイン画面を構築。
- `pairing.dart`:
    - 新規BLEデバイスをスキャンし、ユーザーがペアリング（接続）するための画面。
- `connect_page.dart`:
    - 接続後のデバイスと対話（データの読み書きなど）を行うための画面。
- `models/paired_device.dart`:
    - ペアリング済みデバイスの情報を保持するためのデータモデルクラスを定義。デバイスIDや名前などが含まれる。
- `utils/app_constants.dart`:
    - アプリケーション全体で利用する定数（例: `shared_preferences`のキーなど）を定義。

### その他主要ファイル・ディレクトリ

- `pubspec.yaml`: プロジェクトの依存ライブラリ、アセット、フォントなどを定義する設定ファイル。
- `analysis_options.yaml`: Dartの静的解析（Lint）ルールを定義。コード品質を維持するために`flutter_lints`が採用されている。
- `test/`: アプリケーションの単体テストやウィジェットテストを格納するディレクトリ。
- `ios/` & `android/`: 各プラットフォーム固有の設定やコードを格納するディレクトリ。BLEやパーミッションに関するネイティブ設定（`Info.plist`や`AndroidManifest.xml`）が含まれる。

## 4. 主要な機能と実装の流れ

1.  **パーミッション要求**:
    - `permission_handler` を使用し、アプリ起動時やスキャン前にBluetoothと位置情報の利用許可をユーザーに求める。
2.  **デバイススキャン**:
    - `pairing.dart`画面で`flutter_blue_plus`の`startScan`を呼び出し、周辺のBLEデバイスを探索する。
    - 発見したデバイスをリスト表示する。
3.  **接続とペアリング**:
    - ユーザーがリストからデバイスを選択すると、`connect`メソッドで接続を試みる。
    - 接続に成功したデバイス情報は`shared_preferences`を利用して永続化する。
4.  **デバイスリスト表示**:
    - `main.dart`画面で`shared_preferences`からペアリング済みデバイスリストを読み込む。
    - `flutter_blue_plus`で各デバイスの現在の接続状態（Connected/Disconnected）を確認し、2つのリストに分けて表示する。
5.  **デバイスとの対話**:
    - 接続済みデバイスを選択すると`connect_page.dart`に遷移し、サービスの探索やキャラクタリスティックの読み書きを行う。
6.  **位置情報取得と地図アプリ連携**:
    - `geolocator`を用いてスマートフォンの現在位置情報を取得する。
    - `url_launcher`を用いて取得した位置情報を外部の地図アプリケーションに渡し、表示する。
7.  **デバイス切断時の位置情報記録**:
    - Bluetoothデバイスが切断された際、バックグラウンドでスマートフォンの位置情報を自動的に取得し、デバイスに紐付けて永続化する。
8.  **切断デバイスの最終位置表示**:
    - 永続化された最終位置情報を読み込み、地図アプリケーションで表示する。
9.  **デバイス削除時の位置情報削除**:
    - デバイスがアプリから削除された際、関連する位置情報もストレージから削除する。

## 5. 開発ワークフロー

- **依存関係のインストール**:
  ```bash
  flutter pub get
  ```
- **アプリケーションの実行**:
  ```bash
  flutter run
  ```
- **コードの静的解析 (Lint)**:
  ```bash
  flutter analyze
  ```
- **テストの実行**:
  ```bash
  flutter test
  ```

## 6. コーディング規約

- DartおよびFlutterの標準的なコーディング規約に従う。
- `analysis_options.yaml`に定義されたLintルールを遵守する。
- UIコンポーネントは`main.dart`で見られるような統一されたスタイル（`Scaffold`, `AppBar`の色: `0xFF66B2A3`など）を維持する。

## 7. アルゴリズム的知見と設計パターン

### 7.1. BLEデバイスのスキャンとフィルタリング

-   `flutter_blue_plus`の`startScan`メソッドは、周辺のBLEデバイスを非同期ストリームとして継続的に発見します。
-   スキャン結果から重複するデバイスを除外したり、特定のサービスUUIDを持つデバイスのみを対象とするフィルタリングロジックが実装されています。これは、効率的なデバイス発見と目的のデバイスへの絞り込みに寄与します。

### 7.2. デバイス状態管理

-   `main.dart`における接続済み・未接続デバイスのリスト表示では、`flutter_blue_plus`が提供するデバイスの接続状態（`connectionState`）のストリームを購読し、UIをリアルタイムで更新するパターンが採用されています。
-   Flutterの`StreamBuilder`や、より高度な状態管理ソリューション（例: Provider, Riverpodなど、プロジェクトの規模に応じて選択）が、非同期データフローとUIの同期に利用されている可能性があります。

### 7.3. 永続化とデータ構造

-   `shared_preferences`を用いたデバイス情報の永続化は、キーバリュー形式のシンプルなストレージを利用しています。
-   `models/paired_device.dart`で定義された`PairedDevice`クラスは、デバイスの識別子（ID）と表示名などの情報を保持するデータ構造として機能します。このクラスは、永続化されたデータをアプリケーション内で扱いやすいオブジェクトに変換するために利用されます。
-   ペアリング済みデバイスのリストは、アプリケーションの起動時に読み込まれ、接続・切断イベントに応じて追加・削除・更新といった基本的なリスト操作が行われます。
-   **位置情報データの管理**: デバイスの切断時に記録される位置情報は、タイムスタンプと共に各デバイスに紐付けて保存されます。複数の切断履歴を保持する場合、リスト形式で管理し、最新のものを優先的に表示するなどのロジックが必要となります。

### 7.4. 非同期処理とエラーハンドリング

-   BLE操作（スキャン、接続、データの読み書きなど）は本質的に非同期であるため、Dartの`async/await`パターンが多用されています。これにより、非同期処理のコードが同期処理のように読みやすく記述されています。
-   接続失敗、パーミッション拒否、タイムアウトなどのエラーケースに対しては、`try-catch`ブロックを用いた堅牢なエラーハンドリングが実装されており、ユーザーへの適切なフィードバック（例: トーストメッセージ、ダイアログ）が行われます。
-   **位置情報取得時のエラーハンドリング**: 位置情報サービスが無効な場合や、パーミッションが拒否された場合など、`geolocator`からのエラーを適切に処理し、ユーザーに通知するメカニズムが必要です。

### 7.5. UIとロジックの分離

-   Flutterアプリケーションの設計原則に従い、UI（ウィジェット）とビジネスロジック（データ処理、BLE操作など）の分離が図られています。
-   具体的には、`StatefulWidget`の`State`クラス内でウィジェットの状態と関連ロジックを管理したり、より複雑なロジックは専用のクラス（例: `BluetoothService`のようなサービス層）に切り出すことで、コードの可読性、保守性、テスト容易性を高めています。

### 7.6. バックグラウンド処理の設計

-   デバイス切断時の位置情報記録は、アプリがフォアグラウンドにない場合でも動作する必要があります。このため、プラットフォーム固有のバックグラウンド処理（Android Service, iOS Background Modes）の検討と実装が必要です。
-   バックグラウンドでの位置情報取得はバッテリー消費に影響するため、効率的な取得頻度や、必要な時のみ起動するなどの最適化が求められます。

## 8. プラットフォーム固有の考慮事項

### 8.1. iOS

-   **パーミッション**: iOSでは、`Info.plist`にBluetoothの使用目的を記述する必要があります（`NSBluetoothAlwaysUsageDescription`または`NSBluetoothPeripheralUsageDescription`）。位置情報もBLEスキャンに必要となる場合があります。
-   **位置情報パーミッション**: 位置情報追跡機能のためには、`NSLocationWhenInUseUsageDescription`（アプリ使用中のみ）または`NSLocationAlwaysAndWhenInUseUsageDescription`（常に）の記述が必要です。バックグラウンドでの位置情報取得には後者が必要となります。
-   **バックグラウンド動作**: iOSでは、バックグラウンドでのBLEスキャンや接続には特定の要件（`UIBackgroundModes`の設定など）があり、制限が多いです。位置情報取得も同様に、バックグラウンドモードの設定と適切な利用が求められます。
-   **Core Bluetooth**: `flutter_blue_plus`は内部的にiOSのCore Bluetoothフレームワークを利用しており、その制約や挙動に準拠します。

### 8.2. Android

-   **パーミッション**: Android 6.0 (API 23) 以降では、BLEスキャンに位置情報パーミッション（`ACCESS_FINE_LOCATION`または`ACCESS_COARSE_LOCATION`）が必要です。Android 12 (API 31) 以降では、`BLUETOOTH_SCAN`, `BLUETOOTH_ADVERTISE`, `BLUETOOTH_CONNECT`などの新しいパーミッションが導入されています。
-   **位置情報パーミッション**: 位置情報追跡機能のためには、`ACCESS_FINE_LOCATION`または`ACCESS_COARSE_LOCATION`が必要です。バックグラウンドでの位置情報取得には、Android 10 (API 29) 以降で`ACCESS_BACKGROUND_LOCATION`パーミッションも必要となります。
-   **位置情報サービス**: Androidでは、BLEスキャンを行う際に位置情報サービスが有効になっている必要があります。位置情報追跡機能でも同様に、位置情報サービスが有効になっているかを確認し、無効な場合はユーザーに有効化を促す必要があります。
-   **Bluetoothアダプターの状態**: Bluetoothアダプターが有効になっているかどうかのチェックと、無効な場合にユーザーに有効化を促す処理が必要です。
-   **BluetoothLeScanner**: `flutter_blue_plus`は内部的にAndroidのBluetoothLeScanner APIを利用しており、その制約や挙動に準拠します。

## 9. エラーハンドリングの詳細

-   **ユーザーへのフィードバック**:
    -   **トーストメッセージ/SnackBar**: 短時間で消えるメッセージで、成功や軽微なエラーを通知。
    -   **AlertDialog**: ユーザーの操作が必要な重要なエラーや確認事項を表示。
    -   **エラー画面/状態表示**: 致命的なエラーや、データがない場合などに専用のUIを表示。
-   **具体的なエラーシナリオ**:
    -   **Bluetoothが無効**: ユーザーにBluetoothを有効にするよう促す。
    -   **パーミッション拒否**: 設定画面への誘導や、機能が利用できない旨を伝える。
    -   **デバイスが見つからない**: スキャン結果が空の場合のメッセージ表示。
    -   **接続失敗/切断**: ネットワークの問題やデバイス側の問題で接続が確立できない、または切断された場合の再試行や通知。
    -   **タイムアウト**: 特定の操作（スキャン、接続など）が一定時間内に完了しない場合の処理。

## 10. テスト戦略

-   **ウィジェットテスト**: UIコンポーネントが正しくレンダリングされ、ユーザーインタラクションに反応するかを検証。`main.dart`, `pairing.dart`, `connect_page.dart`などのUI部分が対象。
-   **ユニットテスト**: ビジネスロジックやデータモデル（例: `PairedDevice`クラスのシリアライズ/デシリアライズ）が単体で正しく機能するかを検証。
-   **統合テスト**: アプリケーションの複数のコンポーネントが連携して正しく動作するかを検証。BLE通信のモック化や、実際のデバイスを用いたテストが考えられます。
-   **モック/スタブ**: 実際のBLEデバイスや`shared_preferences`などの外部依存をモック化し、テストの独立性と再現性を確保。

## 11. UI/UXの原則

-   **一貫性のあるデザイン**: `main.dart`で定義されている`AppBar`の色（`0xFF66B2A3`）や`Card`のスタイルなど、プロジェクト全体で統一されたデザインガイドラインに従う。
-   **ユーザーフレンドリーなフィードバック**: BLE操作の進行状況（スキャン中、接続中など）を明確に表示し、ユーザーが現在の状態を理解できるようにする。位置情報取得中や、位置情報サービスが無効な場合など、ユーザーに適切なフィードバックを提供する。
-   **直感的な操作**: デバイスの選択、接続、切断などの主要な操作が直感的に行えるようにUIを設計。位置情報表示ボタンの配置や、地図アプリへのスムーズな遷移を考慮する。
-   **アクセシビリティ**: 可能な範囲で、視覚障害者やその他のユーザーがアプリを利用しやすいように配慮（例: セマンティックラベルの追加）。